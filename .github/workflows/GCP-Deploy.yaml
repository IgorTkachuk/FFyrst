name: GCP-Deploy

on:
  workflow_dispatch:

jobs:

    deploy:

        name: Setup Gcloud Account
        runs-on: ubuntu-latest
        env:
          IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_APP_NAME }}
        steps:

        - name: Login
          uses: google-github-actions/setup-gcloud@master
          with:
            project_id: ${{ secrets.GCP_PROJECT_ID }}
            service_account_email: ${{ secrets.GCP_EMAIL }}
            service_account_key: ${{ secrets.GCP_CREDENTIALS }}

        - name: Configure Docker
          run: gcloud auth configure-docker --quiet

        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Build Docker image
          run: |
            docker build \
            --build-arg REACT_APP_API_ORIGIN_URL=${{ env.REACT_APP_API_ORIGIN_URL }} \
            --build-arg REACT_APP_BACKEND_HOST=${{ env.REACT_APP_BACKEND_HOST }} \
            . -t $IMAGE_NAME

        - name: Push Docker image
          run: docker push $IMAGE_NAME

        - name: Deploy Docker image
          run: |
            gcloud secrets delete DB_PASSWORD --quiet && \
            gcloud secrets create DB_PASSWORD --replication-policy="automatic" && \
            gcloud secrets add-iam-policy-binding DB_PASSWORD --member="serviceAccount:${{ secrets.GCP_EMAIL }}" --role="roles/secretmanager.secretAccessor" && \
            echo -n ${{ secrets.DB_PASSWORD }} | gcloud secrets versions add DB_PASSWORD --data-file=- && \
            gcloud run deploy ${{ secrets.GCP_PROJECT_ID }} --image $IMAGE_NAME \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --memory 512M \
            --set-env-vars "NODE_ENV=development" \
            --set-env-vars DB_NAME=${{ env.DB_NAME }} \
            --set-env-vars DB_USERNAME=${{ env.DB_USERNAME }} \
            --update-secrets=DB_PASSWORD=DB_PASSWORD:latest \
            --set-env-vars DB_HOST=${{ env.DB_HOST }} \
            --set-env-vars DB_PORT=${{ env.DB_PORT }} \
            --set-env-vars DB_DIALECT=${{ env.DB_DIALECT }} \
            --set-env-vars SMTP_HOST =${{ env.SMTP_HOST  }} \
            --set-env-vars SMTP_PORT =${{ env.SMTP_PORT  }} \
            --set-env-vars SMTP_USER =${{ env.SMTP_USER  }} \
            --update-secrets=SMTP_PASS=SMTP_PASS:latest \
            --set-env-vars LINK_HOST =${{ env.LINK_HOST  }} \
            --update-secrets=JWT_SECRET=JWT_SECRET:latest \
            --set-env-vars JWT_EXPIRE_TIME=${{ env.JWT_EXPIRE_TIME }} \
            --update-secrets=JWT_REFRESH_SECRET=JWT_REFRESH_SECRET:latest \
            --set-env-vars JWT_REFRESH_EXPIRE_TIME =${{ env.JWT_REFRESH_EXPIRE_TIME  }} \
            --set-env-vars REDIS_HOST=${{ env.REDIS_HOST }} \
            --set-env-vars REDIS_PORT=${{ env.REDIS_PORT }} \
            --update-secrets=REDIS_PASSWORD=REDIS_PASSWORD:latest \
            --set-env-vars APP_PROTOCOL=${{ env.APP_PROTOCOL }} \
            --set-env-vars APP_HOST=${{ env.APP_HOST }} \
            --set-env-vars APP_PORT=${{ env.APP_PORT }} \
            --set-env-vars CLOUDINARY_CLOUD_NAME=${{ env.CLOUDINARY_CLOUD_NAME }} \
            --update-secrets=CLOUDINARY_API_KEY=CLOUDINARY_API_KEY:latest \
            --update-secrets=CLOUDINARY_API_SECRET=CLOUDINARY_API_SECRET:latest \
            --set-env-vars IMAGE_UPLOAD_BYTE_LIMIT=${{ env.IMAGE_UPLOAD_BYTE_LIMIT }} 
